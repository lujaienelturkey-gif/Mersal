<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ابعتها لمهجة</title>
  <style>
    body{margin:0;font-family:Arial, sans-serif;background:#f6fbff}
    .btn{padding:10px 16px;border:0;border-radius:8px;cursor:pointer;font-weight:bold}
    .btn-primary{background:#0b66ff;color:#fff}
    .btn-outline{background:#fff;border:1px solid #0b66ff;color:#0b66ff}
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.3);z-index:9999}
    .box{background:#fff;padding:20px;border-radius:10px;max-width:400px;text-align:center}
    .track{display:flex;align-items:center;gap:10px;margin:10px 0;padding:10px;border:1px solid #eee;border-radius:8px}
    .green-box{width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:6px;background:#ddd;cursor:pointer}
    .green-box.selected{background:#25c26b;color:#fff;font-weight:bold}
  </style>
</head>
<body>

<!-- شاشة الـ PIN -->
<div class="overlay" id="pinOverlay">
  <div class="box">
    <h3>هاي تامر 😂❤️</h3>
    <p>اكتب الكود هنا يا عسل</p>
    <input id="pinInput" maxlength="6" style="padding:8px;text-align:center;font-size:18px">
    <div>
      <button class="btn btn-primary" id="pinSubmit">خش برجلك اليمين</button>
    </div>
    <p id="pinError" style="color:red;display:none">الكود مش صح، جرّب تاني</p>
  </div>
</div>

<!-- الرسالة -->
<div class="overlay" id="messageOverlay" style="display:none">
  <div class="box">
    <p>بما إن مفيش تواصل بينا غير عن طريق مرسال .. ف انا عملت مرسال محدش يشوفه غيري انا وانت , مش هنتكلم بس تقدر تبعتلي أغنية أو فويس نوت .. و ربنا يخليك لينا يا باشا</p>
    <button class="btn btn-primary" id="enterBtn">يلا أوبح</button>
  </div>
</div>

<main style="padding:20px;max-width:800px;margin:auto">
  <h2>📥 ارفع أغنية أو سجل ڤويس نوت</h2>
  <input type="file" id="fileInput" accept="audio/*" style="margin:10px 0">
  <button class="btn btn-outline" id="recordBtn">🎤 سجل ڤويس</button>
  <button class="btn btn-outline" id="stopBtn" disabled>⏹ إيقاف</button>
  <div id="status"></div>

  <h3>🎶 التراكات</h3>
  <div id="tracksContainer"></div>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://esdsowghlkzvhtciptzw.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzZHNvd2dobGt6dmh0Y2lwdHp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3OTUyMDcsImV4cCI6MjA3NDM3MTIwN30.UbcxM3aPtxNclA5G865eFQrKbqR7JaR6vWfoc68INic";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// عناصر الواجهة
const pinOverlay = document.getElementById("pinOverlay");
  <script>
(function(){
  const PIN = '10326';

  function bindPinAndEnter() {
    const pinOverlay = document.getElementById('pinOverlay');
    const pinInput = document.getElementById('pinInput');
    const pinSubmit = document.getElementById('pinSubmit');
    const pinError = document.getElementById('pinError');
    const enterBtn = document.getElementById('enterBtn') || document.getElementById('enterSiteBtn') || document.getElementById('msgBtn') || document.querySelector('.enter-btn');
    const messageOverlay = document.getElementById('messageOverlay') || document.getElementById('msgOverlay') || document.getElementById('welcomeOverlay');

    if(!pinOverlay || !pinInput || !pinSubmit){
      setTimeout(bindPinAndEnter, 150);
      return;
    }

    pinSubmit.addEventListener('click', function(){
      if(pinInput.value.trim() === PIN){
        if(pinError) pinError.style.display = 'none';
        pinOverlay.style.display = 'none';
        if(messageOverlay) messageOverlay.style.display = 'flex';
      } else {
        if(pinError) pinError.style.display = 'block';
      }
    });

    pinInput.addEventListener('keydown', function(e){
      if(e.key === 'Enter') pinSubmit.click();
    });

    if(enterBtn){
      enterBtn.addEventListener('click', function(){
        if(messageOverlay) messageOverlay.style.display = 'none';
        if(typeof loadTracks === 'function'){ loadTracks(); }
      });
    }
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', bindPinAndEnter);
  } else {
    bindPinAndEnter();
  }
})();
</script>

const pinInput = document.getElementById("pinInput");
const pinSubmit = document.getElementById("pinSubmit");
const pinError = document.getElementById("pinError");
const messageOverlay = document.getElementById("messageOverlay");
const enterBtn = document.getElementById("enterBtn");
const tracksContainer = document.getElementById("tracksContainer");
const fileInput = document.getElementById("fileInput");
const recordBtn = document.getElementById("recordBtn");
const stopBtn = document.getElementById("stopBtn");
const statusDiv = document.getElementById("status");

const PIN = "10326";
let mediaRecorder, chunks=[];

// تحقق من الـ PIN
pinSubmit.addEventListener("click", ()=>{
  if(pinInput.value.trim()===PIN){
    pinOverlay.style.display="none";
    messageOverlay.style.display="flex";
  } else {
    pinError.style.display="block";
  }
});
enterBtn.addEventListener("click", ()=> messageOverlay.style.display="none");

// تحميل التراكات
async function loadTracks(){
  tracksContainer.innerHTML="";
  let { data, error } = await supabase.from("tracks").select("*").order("id",{ascending:false});
  if(error){ console.error(error); return }
  data.forEach(track=>{
    const div=document.createElement("div");
    div.className="track";
    const box=document.createElement("div");
    box.className="green-box"+(track.selected?" selected":"");
    box.textContent=track.selected?"✓":"";
    box.addEventListener("click", async ()=>{
      let { error } = await supabase.from("tracks").update({selected:!track.selected}).eq("id",track.id);
      if(!error){ loadTracks() }
    });
    const info=document.createElement("div");
    info.innerHTML=`<b>${track.file_name}</b><br><audio controls src="${track.file_url}"></audio>
      <a href="${track.file_url}" download>⬇️ نزلني</a>`;
    div.appendChild(box);
    div.appendChild(info);
    tracksContainer.appendChild(div);
  });
}

// رفع ملف
async function uploadTrack(file){
  const path=Date.now()+"_"+file.name;
  let { error:uploadError } = await supabase.storage.from("tracks").upload(path,file);
  if(uploadError){ alert("خطأ في الرفع"); return }
  let { data } = supabase.storage.from("tracks").getPublicUrl(path);
  await supabase.from("tracks").insert([{file_name:file.name,file_url:data.publicUrl,selected:false}]);
  loadTracks();
}
fileInput.addEventListener("change", e=>{
  if(e.target.files[0]) uploadTrack(e.target.files[0]);
});

// تسجيل فويس
recordBtn.addEventListener("click", async ()=>{
  let stream=await navigator.mediaDevices.getUserMedia({audio:true});
  mediaRecorder=new MediaRecorder(stream);
  chunks=[];
  mediaRecorder.ondataavailable=e=>chunks.push(e.data);
  mediaRecorder.onstop=()=>{
    const blob=new Blob(chunks,{type:"audio/webm"});
    const file=new File([blob],"voice.webm",{type:"audio/webm"});
    uploadTrack(file);
    statusDiv.textContent="";
  };
  mediaRecorder.start();
  recordBtn.disabled=true; stopBtn.disabled=false;
  statusDiv.textContent="● جاري التسجيل...";
});
stopBtn.addEventListener("click", ()=>{
  mediaRecorder.stop();
  recordBtn.disabled=false; stopBtn.disabled=true;
});
loadTracks();
</script>
</body>
</html>

