<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø§Ø¨Ø¹ØªÙ‡Ø§ Ù„Ù…Ù‡Ø¬Ø©</title>
<style>
:root{
  --blue:#0b66ff;
  --light:#f6fbff;
  --green:#25c26b;
  --card-shadow:0 6px 18px rgba(11,102,255,0.08);
}
html,body{height:100%;margin:0;font-family:Arial,"Noto Naskh Arabic",sans-serif;background:var(--light);color:#0b2447;}
header{background:linear-gradient(90deg,white 0%, #eaf3ff 100%);border-bottom:1px solid rgba(11,102,255,0.06);padding:20px;display:flex;flex-direction:column;align-items:center;}
.logo{width:54px;height:54px;border-radius:50%;background:var(--blue);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:20px;box-shadow:var(--card-shadow);}
.brand-name{font-family:"Comic Sans MS", cursive, sans-serif;font-size:20px;margin-top:8px;}
main{padding:28px;max-width:980px;margin:20px auto;}
.card{background:white;border-radius:14px;padding:18px;box-shadow:var(--card-shadow);margin-bottom:18px;}
.controls{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;}
.btn{border:0;padding:12px 14px;border-radius:10px;cursor:pointer;font-weight:600}
.btn-primary{background:var(--blue);color:white}
.btn-outline{background:transparent;border:1px solid rgba(11,102,255,0.12);color:var(--blue)}
.dropzone{margin-top:14px;border:2px dashed rgba(11,102,255,0.12);padding:18px;border-radius:12px;text-align:center;color:#1f4f9a;cursor:pointer}
input[type=file]{display:none}
.list{margin-top:16px}
.track{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;border:1px solid rgba(11,102,255,0.04)}
.track-info{flex:1}
.track-title{font-weight:700}
.track-meta{font-size:12px;color:#6a86b2}
.green-box{width:44px;height:44px;border-radius:8px;background:#eee;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;cursor:pointer;box-shadow:0 6px 14px rgba(37,194,107,0.18)}
.green-box.selected{background:var(--green);transform:scale(0.98);}
.download-btn{margin-left:6px;padding:4px 8px;background:var(--blue);color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;}
footer{max-width:980px;margin:10px auto;color:#4b6fa3;text-align:center;font-size:13px;}
.pin-overlay,.msg-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(11,102,255,0.07),rgba(11,102,255,0.12));z-index:9999;}
.pin-box,.msg-box{background:white;padding:26px;border-radius:12px;box-shadow:0 16px 40px rgba(11,102,255,0.12);max-width:420px;width:94%;text-align:center;}
.pin-box h2,.msg-box p{margin:0 0 12px 0;}
.pin-input{font-size:20px;padding:12px;border-radius:10px;border:1px solid #e6eefc;width:100%;box-sizing:border-box;text-align:center}
.pin-submit,.msg-btn{margin-top:12px;padding:10px 14px;border-radius:10px;border:0;background:var(--blue);color:white;font-weight:700;cursor:pointer}
.pin-error{color:#c0392b;margin-top:10px;display:none}
.spinner{display:none;width:24px;height:24px;border:3px solid #f3f3f3;border-top:3px solid var(--blue);border-radius:50%;animation:spin 1s linear infinite;margin-left:6px;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
</style>
</head>
<body>

  <div class="pin-overlay" id="pinOverlay" aria-hidden="false">
  <div class="pin-box" role="dialog" aria-labelledby="pinTitle">
    <h2 id="pinTitle">Ù‡Ø§ÙŠ ØªØ§Ù…Ø± ğŸ˜‚â¤ï¸</h2>
    <p>Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§ ÙŠØ§ Ø¹Ø³Ù„</p>
    <input id="pinInput" class="pin-input" inputmode="numeric" maxlength="6" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù€ PIN" aria-label="Ø±Ù…Ø² Ø§Ù„ÙŠÙ„Ø§ Ø£ÙˆØ¨Ø­">
    <button id="pinSubmit" class="pin-submit">Ø®Ø´ Ø¨Ø±Ø¬Ù„Ùƒ Ø§Ù„ÙŠÙ…ÙŠÙ†</button>
    <div id="pinError" class="pin-error">Ø§Ù„ÙƒÙˆØ¯ Ù…Ø´ ØµØ­ØŒ Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ.</div>
  </div>
</div>


<div class="msg-overlay" id="msgOverlay" style="display:none">
  <div class="msg-box">
    <p>Ø¨Ù…Ø§ Ø¥Ù† Ù…ÙÙŠØ´ ØªÙˆØ§ØµÙ„ Ø¨ÙŠÙ†Ø§ ØºÙŠØ± Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ù…Ø±Ø³Ø§Ù„ .. Ù Ø§Ù†Ø§ Ø¹Ù…Ù„Øª Ù…Ø±Ø³Ø§Ù„ Ù…Ø­Ø¯Ø´ ÙŠØ´ÙˆÙÙ‡ ØºÙŠØ±ÙŠ Ø§Ù†Ø§ ÙˆØ§Ù†Øª, Ù…Ø´ Ù‡Ù†ØªÙƒÙ„Ù… Ø¨Ø³ Ù‡Ù†Ø¨Ø¹Øª Ù„Ø¨Ø¹Ø¶ Ø£ØºØ§Ù†ÙŠ Ø£Ùˆ ÙÙˆÙŠØ³ Ù†ÙˆØª .. Ùˆ Ø±Ø¨Ù†Ø§ ÙŠØ®Ù„ÙŠÙƒ Ù„ÙŠÙ†Ø§ ÙŠØ§ Ø¨Ø§Ø´Ø§</p>
    <button id="msgBtn" class="msg-btn">ÙŠÙ„Ø§ Ø£ÙˆØ¨Ø­</button>
  </div>
</div>

<header>
  <div class="logo">M</div>
  <div class="brand-name">Ø§Ø¨Ø¹ØªÙ‡Ø§ Ù„Ù…Ù‡Ø¬Ø©</div>
</header>

<main>
  <section class="card">
    <h3>Ø­Ù…Ù„ Ø£ØºÙ†ÙŠØ© Ø£Ùˆ Ø§Ø¨Ø¹Øª Ú¤ÙˆÙŠØ³ Ù†ÙˆØª</h3>
    <div class="controls">
      <label class="btn btn-outline" for="fileInput">Ø±ÙØ¹ Ù…Ù„Ù ØµÙˆØªÙŠ</label>
      <input id="fileInput" type="file" accept="audio/*">
      <button id="recordBtn" class="btn btn-primary">Ø³Ø¬Ù„ Ú¤ÙˆÙŠØ³ Ù†ÙˆØª</button>
      <button id="stopBtn" class="btn btn-outline" disabled>Ø¥ÙŠÙ‚Ø§Ù</button>
      <div class="spinner" id="spinner"></div>
      <div id="recordStatus" style="margin-left:12px;display:flex;align-items:center;font-weight:700;color:#0b66ff"></div>
    </div>
    <div class="dropzone" id="dropzone">Ø§Ø³Ø­Ø¨ ÙˆØ£Ø³Ù‚Ø· Ù…Ù„Ù Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ· "Ø±ÙØ¹ Ù…Ù„Ù ØµÙˆØªÙŠ"</div>
    <div class="list card" id="tracksList"></div>
  </section>
</main>

<footer>ØªÙ… Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø£ÙˆÙ„ÙŠ</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://esdsowghlkzvhtciptzw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzZHNvd2dobGt6dmh0Y2lwdHp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3OTUyMDcsImV4cCI6MjA3NDM3MTIwN30.UbcxM3aPtxNclA5G865eFQrKbqR7JaR6vWfoc68INic';
const supabase = Supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
const bucketName = 'tracks';

const pinOverlay = document.getElementById('pinOverlay');
const pinInput = document.getElementById('pinInput');
const pinSubmit = document.getElementById('pinSubmit');
const pinError = document.getElementById('pinError');
const msgOverlay = document.getElementById('msgOverlay');
const msgBtn = document.getElementById('msgBtn');

pinSubmit.addEventListener('click', ()=>{
  if(pinInput.value.trim() === '10326'){
    pinOverlay.style.display='none';
    msgOverlay.style.display='flex';
  }else pinError.style.display='block';
});

msgBtn.addEventListener('click', ()=>{ msgOverlay.style.display='none'; });

const fileInput = document.getElementById('fileInput');
const dropzone = document.getElementById('dropzone');
const tracksContainer = document.getElementById('tracksList');
const recordBtn = document.getElementById('recordBtn');
const stopBtn = document.getElementById('stopBtn');
const recordStatus = document.getElementById('recordStatus');
const spinner = document.getElementById('spinner');

let mediaRecorder=null,chunks=[];

async function fetchTracks(){
  tracksContainer.innerHTML='';
  const { data,error } = await supabase.storage.from(bucketName).list('');
  if(error) { console.log(error); return; }
  data.forEach(file=>{
    const track=document.createElement('div'); track.className='track';
    const greenBox=document.createElement('div'); greenBox.className='green-box';
    greenBox.textContent='âœ“';
    greenBox.addEventListener('click', async ()=>{
      greenBox.classList.toggle('selected');
      const { error } = await supabase.from('track_selections').upsert({file_name:file.name,selected:greenBox.classList.contains('selected')});
      if(error) console.log(error);
    });
    // Check stored selection
    supabase.from('track_selections').select('selected').eq('file_name',file.name).then(r=>{
      if(r.data[0]?.selected) greenBox.classList.add('selected');
    });

    const info=document.createElement('div'); info.className='track-info';
    const title=document.createElement('div'); title.className='track-title'; title.textContent=file.name;
    const audio=document.createElement('audio'); audio.controls=true; audio.src=`${SUPABASE_URL}/storage/v1/object/public/${bucketName}/${file.name}`;
    const downloadBtn=document.createElement('button'); downloadBtn.className='download-btn'; downloadBtn.textContent='Ù†Ø²Ù„Ù†ÙŠ';
    downloadBtn.onclick=()=>{ window.open(audio.src,'_blank'); };
    info.appendChild(title); info.appendChild(audio); info.appendChild(downloadBtn);

    track.appendChild(greenBox); track.appendChild(info);
    tracksContainer.prepend(track);
  });
}
fetchTracks();

fileInput.addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  spinner.style.display='inline-block';
  const { error } = await supabase.storage.from(bucketName).upload(f.name,f,{upsert:true});
  spinner.style.display='none';
  if(error){alert('Error uploading: '+error.message);return;}
  await fetchTracks();
});

['dragenter','dragover'].forEach(ev=>{
  dropzone.addEventListener(ev,e=>{e.preventDefault();dropzone.style.borderColor='rgba(11,102,255,0.4)';});
});
['dragleave','drop'].forEach(ev=>{
  dropzone.addEventListener(ev,e=>{e.preventDefault();dropzone.style.borderColor='rgba(11,102,255,0.12)';});
});
dropzone.addEventListener('drop',async e=>{
  const f=e.dataTransfer.files[0]; if(f){spinner.style.display='inline-block';
    const { error } = await supabase.storage.from(bucketName).upload(f.name,f,{upsert:true});
    spinner.style.display='none'; if(error){alert('Error uploading: '+error.message); return;}
    await fetchTracks();
  }
});

recordBtn.addEventListener('click',async ()=>{
  if(mediaRecorder && mediaRecorder.state==='recording') return;
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder=new MediaRecorder(stream); chunks=[];
    mediaRecorder.ondataavailable=e=>chunks.push(e.data);
    mediaRecorder.onstart=()=>{
      recordBtn.textContent='Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...'; stopBtn.disabled=false;
      recordStatus.textContent='â— ØªØ³Ø¬ÙŠÙ„';
    }
    mediaRecorder.onstop=async ()=>{
      recordBtn.textContent='Ø³Ø¬Ù„ Ú¤ÙˆÙŠØ³ Ù†ÙˆØª'; stopBtn.disabled=true;
      recordStatus.textContent='';
      const blob=new Blob(chunks,{type:'audio/webm'});
      const fileName=`voice_${Date.now()}.webm`;
      spinner.style.display='inline-block';
      const { error } = await supabase.storage.from(bucketName).upload(fileName,blob,{upsert:true});
      spinner.style.display='none'; if(error){alert('Error uploading: '+error.message);return;}
      await fetchTracks();
    }
    mediaRecorder.start();
  }catch(err){alert('Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø£Ø°Ù†.');}
});

stopBtn.addEventListener('click', ()=>{ if(mediaRecorder && mediaRecorder.state==='recording') mediaRecorder.stop(); });
</script>
</body>
</html>

