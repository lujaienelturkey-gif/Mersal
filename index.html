<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø§Ø¨Ø¹ØªÙ‡Ø§ Ù„Ù…Ù‡Ø¬Ø©</title>
<style>
:root{
  --blue:#0b66ff;
  --light:#f6fbff;
  --green:#25c26b;
  --card-shadow:0 6px 18px rgba(11,102,255,0.08);
}
html,body{
  height:100%;
  margin:0;
  font-family:Arial,sans-serif;
  background:var(--light);
  color:#0b2447;
  display: flex;
  flex-direction: column; /* Ù„Ø¬Ø¹Ù„ Ø§Ù„ÙÙˆØªØ± ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ */
}
header{text-align:center;padding:20px}
.logo{font-size:40px;font-weight:700;color:var(--blue)}
.subtitle{font-size:16px;color:#205aa8;font-family:cursive;display:flex;align-items:center;justify-content:center;gap:8px}

main{
  padding:20px;
  max-width:600px;
  margin:auto;
  flex: 1; /* Ù„Ø¬Ø¹Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙŠÙ…ØªØ¯ ÙˆÙŠØ¬Ø¹Ù„ Ø§Ù„ÙÙˆØªØ± ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ */
}
.card{background:white;border-radius:14px;padding:18px;box-shadow:var(--card-shadow);margin-bottom:18px}

.btn{border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
.btn-primary{background:var(--blue);color:white}
.green-box{width:32px;height:32px;border-radius:6px;border:2px solid #ccc;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px}
.green-box.active{background:var(--green);color:#fff;border-color:var(--green)}
.download-btn{margin-right:10px;color:var(--blue);cursor:pointer;border:none;background:none;text-decoration:underline;font-size:14px}

.track{display:flex;align-items:center;justify-content:space-between;padding:8px;border-bottom:1px solid #eee}
.track audio{max-width:200px}
#welcomeOverlay{position:fixed;inset:0;background:#fff;display:none;align-items:center;justify-content:center;z-index:1000}
#welcomeBox{max-width:500px;text-align:center;padding:20px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.1);background:white}
#welcomeBox p{margin-bottom:16px}
#welcomeBox button{padding:10px 14px;border:0;background:var(--blue);color:#fff;border-radius:10px;cursor:pointer;font-weight:bold}
.pin-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.05);display:flex;align-items:center;justify-content:center;z-index:2000}
.pin-box{background:white;padding:26px;border-radius:12px;box-shadow:0 16px 40px rgba(11,102,255,0.12);max-width:420px;width:94%;text-align:center}
.pin-input{font-size:20px;padding:12px;border-radius:10px;border:1px solid #e6eefc;width:100%;box-sizing:border-box;text-align:center}
.pin-submit{margin-top:12px;padding:10px 14px;border-radius:10px;border:0;background:var(--blue);color:white;font-weight:700;cursor:pointer}
.pin-error{color:#c0392b;margin-top:10px;display:none}

/* Spinner */
#spinner{display:none;margin-left:8px;border:4px solid #f3f3f3;border-top:4px solid var(--blue);border-radius:50%;width:18px;height:18px;animation:spin 1s linear infinite;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

/* Footer Styles */
footer {
  background: transparent;
  text-align: center;
  padding: 15px 0;
  font-size: 22px;
  margin-top: auto; /* ÙŠØ¯ÙØ¹ Ø§Ù„ÙÙˆØªØ± Ù„Ù„Ø£Ø³ÙÙ„ */
}
</style>
</head>
<body>

<div class="pin-overlay" id="pinOverlay">
  <div class="pin-box">
    <h2>Ù‡Ø§ÙŠ ØªØ§Ù…Ø± ğŸ˜‚â¤ï¸</h2>
    <p>Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§ ÙŠØ§ Ø¹Ø³Ù„</p>
    <input id="pinInput" class="pin-input" inputmode="numeric" maxlength="6" placeholder="PIN">
    <button id="pinSubmit" class="pin-submit">Ø®Ø´ Ø¨Ø±Ø¬Ù„Ùƒ Ø§Ù„ÙŠÙ…ÙŠÙ†</button>
    <div id="pinError" class="pin-error">Ø§Ù„ÙƒÙˆØ¯ Ù…Ø´ ØµØ­</div>
  </div>
</div>

<div id="welcomeOverlay">
  <div id="welcomeBox">
    <p>Ø§Ù†Ø§ Ù†Ø³ÙŠØª Ø§Ù‚ÙˆÙ„Ùƒ Ø§Ù† Ø§Ù†Ø§ Ø§ØµÙ„Ø§ Ø§Ø®ØªØ±Øª Ø§Ù„Ø±Ø§Ø¬Ù„ Ø§Ù„ØµØ­ ÙŠØ§ Ø§Ø¨Ùˆ Ø¹Ù„ÙŠ</p>
    <button id="enterBtn">â¤ï¸</button>
  </div>
</div>

<header>
  <div class="logo">ğŸµ</div>
  <div class="subtitle">Ø§Ø¨Ø¹ØªÙ‡Ø§ Ù„Ù…Ù‡Ø¬Ø© ğŸ˜‚â¤ï¸</div>
</header>

<main>
  <section class="card">
    <h3>Ø§Ø¨Ø¹Øª Ø£ØºÙ†ÙŠØ© ØªØ­Ù„ÙŠ Ø§Ù„Ø³ÙƒÙˆØª</h3>
    <input type="file" id="fileInput" accept="audio/*">
    <button class="btn btn-primary" id="uploadBtn">Upload <div id="spinner"></div></button>
    <div id="tracksList"></div>
  </section>
</main>

<footer>
  ğŸ¦¦â¤ï¸
</footer>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const SUPABASE_URL = "https://esdsowghlkzvhtciptzw.supabase.co"
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzZHNvd2dobGt6dmh0Y2lwdHp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3OTUyMDcsImV4cCI6MjA3NDM3MTIwN30.UbcxM3aPtxNclA5G865eFQrKbqR7JaR6vWfoc68INic"
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
const bucketName = "tracks"

const fileInput = document.getElementById('fileInput')
const uploadBtn = document.getElementById('uploadBtn')
const spinner = document.getElementById('spinner')
const tracksList = document.getElementById('tracksList')

async function loadTracks(){
  const { data: files, error } = await supabase.storage.from(bucketName).list()
  tracksList.innerHTML = ""
  if(error) return console.error(error)

  // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ù† Ø¬Ø¯ÙˆÙ„ 'track_selections'
  const { data: selections, error: selectionsError } = await supabase.from('track_selections').select('*')
  if(selectionsError) {
    console.error("Error fetching selections:", selectionsError);
    return;
  }
  const selectionMap = new Map(selections.map(s => [s.file_name, s.selected]));


  for(const file of files){
    const { data: urlData } = supabase.storage.from(bucketName).getPublicUrl(file.name)
    const url = urlData.publicUrl
    const trackDiv = document.createElement('div')
    trackDiv.className = 'track'
    trackDiv.innerHTML = `
      <audio controls src="${url}"></audio>
      <div style="display:flex;align-items:center">
        <button class="download-btn" onclick="window.open('${url}')">Ù†Ø²Ù„Ù†ÙŠ</button>
        <div class="green-box"></div>
      </div>
    `
    const box = trackDiv.querySelector('.green-box')
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙˆØªØ·Ø¨ÙŠÙ‚Ù‡Ø§
    const selected = selectionMap.get(file.name);
    if(selected){
      box.classList.add('active');
      box.innerHTML='âœ“';
    }

    box.addEventListener('click', async ()=>{
      const newState = !box.classList.contains('active')
      box.classList.toggle('active', newState)
      box.innerHTML = newState?'âœ“':''

      // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const { error: upsertError } = await supabase
        .from('track_selections')
        .upsert({ file_name: file.name, selected: newState }, { onConflict: 'file_name' });

      if (upsertError) {
        console.error("Error updating selection state:", upsertError);
      }
    })
    tracksList.appendChild(trackDiv)
  }
}

uploadBtn.addEventListener('click', async ()=>{
  const file = fileInput.files[0]
  if(!file) return alert("Ø§Ø®ØªØ§Ø± Ù…Ù„Ù Ø§Ù„Ø£ÙˆÙ„!")
  spinner.style.display="inline-block"
  const safeName = file.name.replace(/[^a-zA-Z0-9.\-_]/g,"_")
  const filePath = `${Date.now()}_${safeName}`
  const { error } = await supabase.storage.from(bucketName).upload(filePath,file)
  spinner.style.display="none"
  if(error){ alert("Ø­ØµÙ„Øª Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø±ÙØ¹: "+error.message) }
  else { fileInput.value=""; await loadTracks() }
})

loadTracks()

const PIN = "10326"
const pinOverlay = document.getElementById('pinOverlay')
const pinInput = document.getElementById('pinInput')
const pinSubmit = document.getElementById('pinSubmit')
const pinError = document.getElementById('pinError')
const welcomeOverlay = document.getElementById('welcomeOverlay')
const enterBtn = document.getElementById('enterBtn')

pinSubmit.addEventListener('click',()=>{
  if(pinInput.value===PIN){
    pinOverlay.style.display='none'
    welcomeOverlay.style.display='flex'
  }else pinError.style.display='block'
})

enterBtn.addEventListener('click',()=>{
  welcomeOverlay.style.display='none'
})
</script>

</body>
</html>





